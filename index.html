<!DOCTYPE html>
<html>
<head>
<title>水道管理アプリ</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
<link rel="stylesheet" href="./main.css">
<script src="./main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>


<style>
#ex_chart {max-width:640px;max-height:480px;}
</style>




<script type="text/javascript">
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
                ethereum.enable()
                web3.version.getNetwork((error, result) => {
                    $('#networkid').text('Network ID: '+result)
                })
                var account;
                web3.eth.getAccounts((error, result) => {
                    $('#accounts').text('Your accounts: '+result)
                    account = result[0]
                })
            } else {
                document.write('Install <a href="https://metamask.io">METAMASK</a>')
            }

var abi=[{"constant":false,"inputs":[],"name":"change_working","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"deposit","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[],"name":"payment","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_amount_of_water","type":"uint256"}],"name":"set","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"set_history","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"basic_rate","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"calc_charge","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_amount_of_water","type":"uint256"}],"name":"calc_commodity_charge","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"get_amount_of_water","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"get_history_charge","outputs":[{"name":"","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"get_history_water","outputs":[{"name":"","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"get_unpaid_charge","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"get_wallet","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"history_charge","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"history_water","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"not_pay_counter","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"on_working","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"unpaid_charge","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}];
const contractadd="0xd42353b11e44a79ae77cd3cd45e129a866e7e51f";

function getUserwallet(){
  const myContract=web3.eth.contract(abi).at(contractadd);
	console.log(account)
  myContract.get_wallet.call({from:account},(error, result)=> {
	console.log(account);
	  $('.balance').text('あなたのデポジットは'+result+'weiです')
	console.log(result)
 	 }
	);
}

setTimeout(function(){getUserwallet();}, 500);
setTimeout(function(){getUseamount();}, 500);
setTimeout(function(){getHistoryofWater();}, 500);


//水の量セット
function setamount(){
  var input=document.forms[0].elements[0].value;
  const myContract=web3.eth.contract(abi).at(contractadd);
  myContract.set.sendTransaction(input,{from:account},(error, result)=>{console.log})
}

//使用した水の量を受け取る
function getUseamount(){
  const myContract=web3.eth.contract(abi).at(contractadd);
  myContract.get_amount_of_water.call({from:account},console.log)
}

//depositする
function Deposit(){
  var input=document.forms[1].elements[0].value;
  const myContract=web3.eth.contract(abi).at(contractadd);
  myContract.deposit.sendTransaction({from:account,to:contractadd,value:web3.toWei(input, "ether")},(error,result)=>{
	  console.log(result);
	  getUserwallet();
	  console.log("a")
	  });
}
//使用した水の量の履歴を受け取る



//使用した料金の履歴を受け取る
function get(){
  const myContract=web3.eth.contract(abi).at(contractadd);
  myContract.get_amount_of_water.call({from:account},console.log)
}



</script>
</head>
<body>
<header class="head">
  <h1><b>水道自動決済アプリケーション</h1>
</header>
<div class="main">
  <div id="networkid"></div>
  <div id="accounts"></div>
  <div id="txhash"></div>
  <canvas id="ex_chart"></canvas>
<br>
<p>使用量入力
<form>
  <input type="text" class='input'>
  <input type='submit' value='送信' onclick="setamount()">
</form>
<br>
<p>金額入力
<form>
  <input type="text" class="inputd">
  <input type='submit' value='送信' onclick="Deposit()">
  <div class="button"></div>
</form>
<div class="use_amount"></div>
<br>
<div class="balance"></div>
<canvas id="ex_chart"></canvas>
<script>
function getHistoryofWater(){
var now   = new Date();
var year  = now.getFullYear(); //年
var month = now.getMonth();    //月

var amount_of_water;
amount_of_water = [20, 30, 50, 40, 39, 40, 10, 10, 34, 50, 11, 20, 49, 12, 21, 60, 19]
const myContract=web3.eth.contract(abi).at(contractadd);
myContract.get_history_water.call({from:account},(error, result)=> {
	var amount_of_water = result;
		console.log(result)
		console.log(result[0] + "FF")
	 	 });
console.log(amount_of_water);
label = []
console.log(amount_of_water)
var len = amount_of_water.length;
for (var i = 0; i < len; i++) {
		    console.log(-4 % 12)
    label.push((month + 12 - (len - i) % 12) % 12 + 1);
}


var ctx = document.getElementById('ex_chart');

var data = {
    labels: label,
    datasets: [{
        label: '水使用量',
        data: amount_of_water,
        backgroundColor: 'rgba(70, 210, 255, 1)'
    }]
};

var options = {
    scales: {
        yAxes: [{
            ticks: {
                min: 0
            }
        }]
    }
};

var ex_chart = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: options
});
}
</script>

</div>
<footer class="footer">omete_IoT</footer>
</body>
</html>

