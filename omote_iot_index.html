<!DOCTYPE html>
<html>
<head>
<title>水道管理アプリ</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
<link rel="stylesheet" href="./main.css">
<script src="./main.js"></script>
<script type="text/javascript">
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
                ethereum.enable()
                web3.version.getNetwork((error, result) => {
                    $('#networkid').text('Network ID: '+result)
                })
                var account;
                web3.eth.getAccounts((error, result) => {
                    $('#accounts').text('Your accounts: '+result)
                    account = result[0]
                })
            } else {
                document.write('Install <a href="https://metamask.io">METAMASK</a>')
            }

var abi=[
	{
		"constant": true,
		"inputs": [],
		"name": "get_wallet",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "calc_charge",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "payment",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_amount_of_water",
				"type": "uint256"
			}
		],
		"name": "set",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "collected_money",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "deposit",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "basic_rate",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_amount_of_water",
				"type": "uint256"
			}
		],
		"name": "calc_commodity_charge",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"name": "member",
		"outputs": [
			{
				"name": "amount_of_water",
				"type": "uint256"
			},
			{
				"name": "diameter",
				"type": "uint256"
			},
			{
				"name": "wallet",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "get_amount_of_water",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
];
const contractadd="0x62dac28e22a0faaf20bfa065658777d1ccc3a94e";

function getUserwallet(){
  const myContract=web3.eth.contract(abi).at(contractadd);
	console.log(account)
  myContract.get_wallet.call({from:account},(error, result)=> {
	console.log(account);
	  $('.balance').text('あなたのデポジットは'+result+'weiです')
	console.log(result)
 	 }
	);
}

setTimeout(function(){getUserwallet();}, 500);
setTimeout(function(){getUseamount();}, 500);

//水の量セット
function setamount(){
  var input=document.forms[0].elements[0].value;
  const myContract=web3.eth.contract(abi).at(contractadd);
  myContract.set.sendTransaction(input,{from:account},(error, result)=>{console.log})
}

//使用した水の量を受け取る
function getUseamount(){
  const myContract=web3.eth.contract(abi).at(contractadd);
  myContract.get_amount_of_water.call({from:account},console.log)
}

//depositする
function Deposit(){
  var input=document.forms[1].elements[0].value;
  const myContract=web3.eth.contract(abi).at(contractadd);
  myContract.deposit.sendTransaction({from:account,to:contractadd,value:web3.toWei(input, "ether")},(error,result)=>{
	  console.log(result);
	  getUserwallet();
	  console.log("a")
	  });
}
</script>
</head>
<body>
<header class="head">
  <h1><b>水道自動決済アプリケーション</h1>
</header>
<div class="main">
  <div id="networkid"></div>
  <div id="accounts"></div>
  <div id="txhash"></div>
<p><b>TODO
<br>
<p>履歴作成
<p>履歴更新
<p>setの繁栄
<p>履歴を更新する関数

<br>
<p>使用量入力
<form>
  <input type="text" class='input'>
  <input type='submit' value='送信' onclick="setamount()">
</form>
<br>
<p>金額入力
<form>
  <input type="text" class="inputd">
  <input type='submit' value='送信' onclick="Deposit()">
  <div class="button"></div>
</form>
<div class="use_amount"></div>
<br>
<div class="balance"></div>
</div>
<footer class="footer">omete_IoT</footer>
</body>
</html>
